---
// Side-by-side page transition with shrink/slide/expand effect
---

<style is:global>
    /* Light mode (default) */
    :root {
        --color-bg-body: #222;
        --color-bg-content: #eee;
        --color-text: #1a1a1a;
    }

    /* Dark mode via class */
    :root.dark {
        --color-bg-body: #111;
        --color-bg-content: #313131;
        --color-text: #eee;
    }

    /* Dark mode via system preference (when no manual override) */
    @media (prefers-color-scheme: dark) {
        :root:not(.light) {
            --color-bg-body: #111;
            --color-bg-content: #313131;
            --color-text: #eee;
        }
    }

    body {
        background-color: var(--color-bg-body);
        min-height: 100vh;
        overflow-x: hidden;
        color: var(--color-text);
    }

    /* Page content wrapper default state */
    .page-content-wrapper {
        position: relative;
        background-color: var(--color-bg-content);
        min-height: 100vh;
        padding-top: 80px;
        transform-origin: center center;
        will-change: transform, border-radius;
        color: var(--color-text);
    }

    /* Exit animation - shrink then slide left */
    body.is-exiting .page-content-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        animation: exitAnimation 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    /* Enter animation - slide in from right then expand */
    body.is-entering .page-content-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        animation: enterAnimation 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes exitAnimation {
        0% {
            transform: scale(1) translateX(0) translateY(0);
            border-radius: 0;
            box-shadow: none;
        }
        40% {
            transform: scale(0.6) translateX(0) translateY(0);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        100% {
            transform: scale(0.6) translateX(-200%) translateY(0);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
    }

    @keyframes enterAnimation {
        0% {
            transform: scale(0.6) translateX(200%) translateY(0);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        50% {
            transform: scale(0.6) translateX(0) translateY(0);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        100% {
            transform: scale(1) translateX(0) translateY(0);
            border-radius: 0;
            box-shadow: none;
        }
    }

    /* Fix for alignfull inside page-content-wrapper during transitions */
    .page-content-wrapper {
        overflow-x: clip;
    }

    body.is-exiting .page-content-wrapper,
    body.is-entering .page-content-wrapper {
        overflow: hidden;
    }
</style>

<script>
    // Dark/Light mode functionality
    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        const root = document.documentElement;

        if (savedTheme === 'dark') {
            root.classList.add('dark');
            root.classList.remove('light');
        } else if (savedTheme === 'light') {
            root.classList.add('light');
            root.classList.remove('dark');
        }
        // If no saved theme, system preference will be used via CSS
    }

    function toggleTheme() {
        const root = document.documentElement;
        const isDark = root.classList.contains('dark') ||
            (!root.classList.contains('light') && window.matchMedia('(prefers-color-scheme: dark)').matches);

        if (isDark) {
            root.classList.remove('dark');
            root.classList.add('light');
            localStorage.setItem('theme', 'light');
        } else {
            root.classList.remove('light');
            root.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        }
    }

    // Initialize theme on load
    initTheme();

    // Expose toggle function globally
    (window as any).toggleTheme = toggleTheme;

    function isInternalLink(href: string | null): boolean {
        if (!href) return false;
        return !href.startsWith('http') &&
               !href.startsWith('#') &&
               !href.startsWith('mailto:') &&
               !href.startsWith('tel:');
    }

    // Handle all internal link clicks
    document.addEventListener('click', (e) => {
        const link = (e.target as HTMLElement).closest('a');
        if (!link) return;

        const href = link.getAttribute('href');

        // Skip external links, anchors, and special links
        if (!isInternalLink(href) ||
            link.hasAttribute('download') ||
            link.getAttribute('target') === '_blank') {
            return;
        }

        // Skip if navigating to the current page
        const currentPath = window.location.pathname;
        const targetPath = new URL(href, window.location.origin).pathname;
        if (currentPath === targetPath ||
            currentPath === targetPath + '/' ||
            currentPath + '/' === targetPath) {
            e.preventDefault();
            return;
        }

        e.preventDefault();

        // Set flag for the new page
        sessionStorage.setItem('pageTransition', 'true');

        // Start exit animation (shrink then slide left)
        document.body.classList.add('is-exiting');

        // Navigate after exit animation completes
        setTimeout(() => {
            window.location.href = href!;
        }, 800);
    });

    // On page load, check if we came from a transition
    if (sessionStorage.getItem('pageTransition') === 'true') {
        sessionStorage.removeItem('pageTransition');

        // Start enter animation (slide in from right then expand)
        document.body.classList.add('is-entering');

        // Clean up after animation completes
        setTimeout(() => {
            document.body.classList.remove('is-entering');
        }, 1000);
    }

    // WordPress Fit Text functionality
    function fitText() {
        const fitTextElements = document.querySelectorAll('.has-fit-text');
        fitTextElements.forEach((el) => {
            const element = el as HTMLElement;
            const container = element.parentElement;
            if (!container) return;

            // Reset font size to measure natural width
            element.style.fontSize = '';

            const containerWidth = container.clientWidth - 32; // Account for padding

            // Create a temporary span to measure text width
            const tempSpan = document.createElement('span');
            tempSpan.style.visibility = 'hidden';
            tempSpan.style.position = 'absolute';
            tempSpan.style.whiteSpace = 'nowrap';
            tempSpan.style.font = window.getComputedStyle(element).font;
            tempSpan.innerHTML = element.innerHTML;
            document.body.appendChild(tempSpan);

            const textWidth = tempSpan.offsetWidth;
            document.body.removeChild(tempSpan);

            if (textWidth > 0) {
                // Calculate scale ratio and apply font size
                const currentFontSize = parseFloat(window.getComputedStyle(element).fontSize);
                const scale = containerWidth / textWidth;
                const newFontSize = Math.floor(currentFontSize * scale);

                // Cap at reasonable bounds
                const finalFontSize = Math.min(Math.max(newFontSize, 16), 500);
                element.style.fontSize = `${finalFontSize}px`;
            }
        });
    }

    // Run fit text on load and resize
    fitText();
    window.addEventListener('resize', fitText);

    // WordPress Accordion Block functionality
    document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;

        // Handle wp-block-accordion clicks
        const accordionToggle = target.closest('.wp-block-accordion-heading__toggle');
        if (accordionToggle) {
            e.preventDefault();
            const accordionItem = accordionToggle.closest('.wp-block-accordion-item');
            if (accordionItem) {
                const isOpen = accordionItem.classList.contains('is-open');
                const panel = accordionItem.querySelector('.wp-block-accordion-panel');
                const button = accordionToggle as HTMLButtonElement;

                if (isOpen) {
                    // Close accordion
                    accordionItem.classList.remove('is-open');
                    button.setAttribute('aria-expanded', 'false');
                    if (panel) {
                        panel.setAttribute('inert', '');
                    }
                } else {
                    // Open accordion
                    accordionItem.classList.add('is-open');
                    button.setAttribute('aria-expanded', 'true');
                    if (panel) {
                        panel.removeAttribute('inert');
                    }
                }
            }
        }
    });
</script>
